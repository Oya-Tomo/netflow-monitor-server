<source>
  @type netflow
  tag geo.netflow.event
  port 5140
  versions [5, 9]
</source>

<source>
  @type syslog
  port 514
  tag syslog.event
  format syslog
</source>

<match geo.netflow.**>
  @type geoip
  geoip_lookup_key ipv4_src_addr
  <record>
    geoip_country ${country_code['ipv4_src_addr']}
    geoip_city ${city['ipv4_src_addr']}
    geoip_lat ${latitude['ipv4_src_addr']}
    geoip_lon ${longitude['ipv4_src_addr']}
    geoip_pin ${latitude["ipv4_src_addr"]},${longitude["ipv4_src_addr"]}
  </record>
  remove_tag_prefix geo.
  add_tag_prefix es.
  skip_adding_null_record
</match>

<match es.netflow.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  type_name netflow
  logstash_format true
  logstash_prefix flow
  logstash_dateformat %Y%m%d
</match>

<match syslog.**>
  @type copy
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix syslog
    logstash_dateformat %Y%m%d
    include_timestamp true
    <buffer>
      path /var/log/td-agent/buffer/fluentd.back
    </buffer>
  </store>
</match>
