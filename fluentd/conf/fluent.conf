<source>
  @type netflowipfix
  tag netflow.event
  port 5140
</source>

<source>
  @type syslog
  port 514
  tag syslog.event
  format syslog
  <parse>
    @type regexp
    expression /^(?<message>.*)$/
  </parse>
</source>

<filter netflow.event>
  @type record_transformer
  enable_ruby true
  <record>
    ipv4_src_addr ${record["ipv4_src_addr"].to_s}
    ipv4_dst_addr ${record["ipv4_dst_addr"].to_s}
    ipv6_src_addr ${record["ipv6_src_addr"].to_s}
    ipv6_dst_addr ${record["ipv6_dst_addr"].to_s}
  </record>
</filter>

<filter netflow.event>
  @type geoip
  geoip_lookup_keys ipv4_dst_addr
  backend_library geoip2_c
  <record>
    city            ${city.names.en["ipv4_dst_addr"]}
    latitude        ${location.latitude["ipv4_dst_addr"]}
    longitude       ${location.longitude["ipv4_dst_addr"]}
    pin             ${location.latitude["ipv4_dst_addr"]},${location.longitude["ipv4_dst_addr"]}
    country         ${country.iso_code["ipv4_dst_addr"]}
    country_name    ${country.names.en["ipv4_dst_addr"]}
    postal_code     ${postal.code["ipv4_dst_addr"]}
    region_code     ${subdivisions.0.iso_code["ipv4_dst_addr"]}
    region_name     ${subdivisions.0.names.en["ipv4_dst_addr"]}
  </record>
  skip_adding_null_record true
</filter>

<filter netflow.event>
  @type stdout
</filter>

<match netflow.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  type_name netflow
  logstash_format true
  logstash_prefix netflow
  logstash_dateformat %Y%m%d
</match>

<match syslog.**>
  @type copy
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix syslog
    logstash_dateformat %Y%m%d
    include_timestamp true
    <buffer>
      path /var/log/td-agent/buffer/fluentd.back
    </buffer>
  </store>
</match>
